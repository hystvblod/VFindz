<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title data-i18n="header.title.choixcadre">Choisir le cadre de la photo</title>
  <link rel="stylesheet" href="style/main.css">
  <style>
    body { background: #1a1c24; color: #fff; font-family: 'Inter', Arial, sans-serif; }
    .cadre-list { display: flex; flex-wrap: wrap; gap: 18px; justify-content: center; margin-top: 38px; }
    .cadre-item { cursor: pointer; border-radius: 18px; overflow: hidden; padding: 8px; box-shadow: 0 6px 14px #0006; transition: transform 0.14s; background: #23243a; }
    .cadre-item:hover { transform: translateY(-2px); }
    .cadre-item.selected { border: 3px solid #ffd900; transform: scale(1.08); }
    .cadre-preview { width: 92px; height: 92px; position: relative; background: #111; }
    .cadre-preview img { position: absolute; width: 100%; height: 100%; object-fit: contain; }
    .header { text-align: center; margin-top: 24px; font-size: 1.3em; }
    .btn-retour { margin-top: 28px; padding: 10px 30px; border-radius: 12px; border: none; background: #ffd900; color: #23243a; cursor: pointer; }
  </style>
</head>
<body>
  <div class="header" data-i18n="main.chooseframe">Choisis un cadre pour cette photo</div>
  <div id="cadre-list" class="cadre-list"></div>
  <div style="text-align:center;">
    <button class="btn-retour" onclick="history.back()" data-i18n="button.back">Retour</button>
  </div>

  <script>
  // Utiliser les fonctions de cadres.js si dispo
  const norm = (id) => String(id || "").toLowerCase().replace(/^cadre[_-]/, "");

  function getCadresPossedes() {
    // garde comportement existant si non connecté au backend
    try {
      return JSON.parse(localStorage.getItem("cadres_possedes") || '["polaroid_01"]');
    } catch (e) {
      return ["polaroid_01"];
    }
  }

  const params = new URLSearchParams(window.location.search);
  const defiId = params.get("defi");
  const photoData = JSON.parse(localStorage.getItem(`photo_defi_${defiId}`) || '{}');
  const cadres = getCadresPossedes();

  const cadreList = document.getElementById("cadre-list");

  cadres.forEach(cadreId => {
    const idNorm = norm(cadreId);
    const item = document.createElement("div");
    item.className = "cadre-item" + (idNorm === photoData.cadre ? " selected" : "");

    const holder = document.createElement("div");
    holder.className = "cadre-preview";
    holder.style.position = "relative";
    holder.style.width = "92px";
    holder.style.height = "92px";
    holder.style.overflow = "hidden";

    // Photo en fond
    const ph = document.createElement("img");
    ph.src = photoData.photo || "";
    ph.style.position = "absolute";
    ph.style.inset = "0";
    ph.style.width = "100%";
    ph.style.height = "100%";
    ph.style.objectFit = "cover";
    ph.style.zIndex = "1";
    holder.appendChild(ph);

    // Cadre : canvas si draw, sinon image .webp
    const isDraw = (Array.isArray(window.DRAW_IDS) && (window.DRAW_IDS.includes(cadreId) || window.DRAW_IDS.includes(idNorm)))
                   || (window.DRAWERS && window.DRAWERS[idNorm]);

    if (isDraw && typeof window.createCadreElement === "function") {
      const c = window.createCadreElement(idNorm, { w: 92, h: 92 });
      // placer au-dessus de la photo
      c.style.position = "absolute";
      c.style.inset = "0";
      c.style.zIndex = "2";
      holder.appendChild(c);
    } else {
      const img = document.createElement("img");
      img.src = (window.getCadreUrl ? window.getCadreUrl(idNorm)
        : `https://swmdepiukfginzhbeccz.supabase.co/storage/v1/object/public/cadres/${idNorm}.webp`);
      img.style.position = "absolute";
      img.style.inset = "0";
      img.style.width = "100%";
      img.style.height = "100%";
      img.style.objectFit = "contain";
      img.style.zIndex = "2";
      img.style.pointerEvents = "none";
      holder.appendChild(img);
    }

    item.appendChild(holder);

    // Clic -> sauvegarde et retour
    item.onclick = () => {
      photoData.cadre = idNorm;
      localStorage.setItem(`photo_defi_${defiId}`, JSON.stringify(photoData));
      // visuel sélection
      document.querySelectorAll(".cadre-item.selected").forEach(el => el.classList.remove("selected"));
      item.classList.add("selected");
      alert(window.i18n ? window.i18n("alert.success") : "✅ Nouveau cadre appliqué !");
      history.back();
    };

    cadreList.appendChild(item);
  });
  </script>

  <script src="js/i18lang.js"></script>
  <script src="js/cadres.js"></script>
</body>
</html>
