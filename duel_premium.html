<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title data-i18n="duel_premium.title">Duel Premium</title>
  <link rel="stylesheet" href="style/main.css" />
  <style>
    .duel-main{max-width:420px;margin:2.4rem auto 0;background:rgba(38,41,56,.93);border-radius:1.3rem;box-shadow:0 8px 32px #0003,0 2px 0 #232435;padding:2.2rem 1.4rem 1.6rem}
    .section-titre{color:#e8eaf6;font-size:1.15em;font-weight:600;margin:1.7em 0 .7em;text-align:center}
    .amis-list{display:flex;flex-direction:column;gap:1.1rem;margin-bottom:2.2rem}
    .ami-card{display:flex;align-items:center;justify-content:space-between;background:#2e3047;border-radius:.9rem;padding:.9em 1.2em;box-shadow:0 3px 12px #0002;min-height:52px}
    .ami-nom{font-weight:600;font-size:1.14em;color:#ffe04a;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px}
    .btn-duel-ami{background:#ffe04a;color:#2b2b2b;font-weight:700;border:none;border-radius:8px;padding:7px 16px;font-size:1.03em;box-shadow:0 2px 8px #0002;cursor:pointer}
    .duel-demandes-list{background:#24263b;border-radius:.9rem;padding:1em 1em .6em;min-height:45px;box-shadow:0 2px 8px #0001}
    .demande-card{display:flex;align-items:center;justify-content:space-between;margin-bottom:.6em;gap:.6em}
    .demande-nom{font-weight:500;color:#ffe04a;font-size:1.03em;max-width:160px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .badge-nouveau{background:#ffe04a;color:#2a2a23;font-size:.97em;border-radius:6px;padding:1px 7px;margin-left:5px;font-weight:700;box-shadow:0 1px 4px #0001}
    .btn-accepter,.btn-refuser{border:none;border-radius:8px;padding:6px 14px;font-weight:700;font-size:.97em;cursor:pointer}
    .btn-accepter{background:#65e965;color:#253a25}
    .btn-refuser{background:#f36d6d;color:#232323}
    .aucune-demande{color:#bdbdc8;text-align:center;font-size:1.01em;margin:.3em 0 .8em}
    /* POPUP */
    #popup-defi-premium{position:fixed;inset:0;z-index:99999;display:none;align-items:center;justify-content:center;background:rgba(30,32,48,.84);width:100vw;height:100vh}
    #popup-defi-premium.show{display:flex}
    .popup-inner{background:#232435;border-radius:1.23em;padding:1.6em 1.2em 1.2em;width:440px;max-width:94vw;box-shadow:0 8px 28px #0007;color:#e9ecff}
    .premium-badge{border-radius:7px;padding:4px 13px;font-size:1.04em;font-weight:700;margin-bottom:10px;background:#ffe04a;color:#242424;display:inline-block}
    .popup-title{font-size:1.21em;font-weight:800;color:#ffe04a;margin:4px 0 10px}
    .popup-input{width:100%;border-radius:9px;padding:10px;margin-bottom:10px;border:1.5px solid #ffe04a;font-size:1.02em;background:#1f2133;color:#fff}
    .popup-actions{display:flex;gap:.6em;justify-content:flex-end;margin-top:8px}
    .btn-primary{background:#ffe04a;color:#232323;font-weight:800;border:none;border-radius:9px;padding:10px 22px;font-size:1.02em;box-shadow:0 2px 8px #0002;cursor:pointer}
    .btn-ghost{background:#dddbe2;color:#222;border:none;border-radius:9px;padding:10px 22px;font-size:1.02em}
    @media (max-width:600px){
      .duel-main{max-width:98vw;padding:1.1em .5em}
      .ami-nom{max-width:110px}
      .demande-nom{max-width:90px}
      .popup-inner{width:92vw}
    }
  </style>
</head>
<body class="duel-container">

  <header class="header-solo">
    <div class="header-row">
      <a href="index.html" class="back-btn" title="Retour" data-i18n-title="header.back">
        <img src="assets/icons/arrow_back.svg" alt="Retour" data-i18n-alt="header.back"/>
      </a>
      <h1 data-i18n="duel_premium.title">Duel Premium</h1>
      <div class="top-buttons">
        <a href="profil.html" class="btn-icon" aria-label="Profil" data-i18n-aria-label="button.profile">
          <img src="assets/icons/user.svg" alt="Profil" data-i18n-alt="button.profile" />
        </a>
        <a href="parametres.html" class="btn-icon" aria-label="Paramètres" data-i18n-aria-label="button.settings">
          <img src="assets/icons/settings.svg" alt="Paramètres" data-i18n-alt="button.settings" />
        </a>
      </div>
    </div>
    <div class="solde-container solde-solo" id="solde-container">
      <div class="solde-item">
        <div class="solde-ligne">
          <img src="assets/img/vcoin.webp" class="icon-solo-piece" alt="Pièces" data-i18n-alt="solde.pieces" />
          <span id="points"></span>
        </div>
      </div>
      <div class="solde-item">
        <div class="solde-ligne">
          <img src="assets/img/jeton_p.webp" class="icon-solo-jeton" alt="Jetons" data-i18n-alt="solde.jetons" />
          <span id="jetons"></span>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="duel-main">
      <div id="premium-alert" style="display:none;color:#f36d6d;text-align:center;margin-bottom:1.1em;font-weight:bold" data-i18n="duel_premium.premium_only">Invitation réservée aux premium.</div>

      <div class="section-titre" data-i18n="duel_premium.section.friends">Mes amis</div>
      <div id="liste-amis" class="amis-list"></div>

      <div class="section-titre" style="margin-top:2.4em" data-i18n="duel_premium.section.received">Demandes de duel premium reçues</div>
      <div id="demandes-recue" class="duel-demandes-list"></div>

      <div class="section-titre" style="margin-top:2.4em" data-i18n="duel_premium.section.sent">Demandes de duel premium envoyées</div>
      <div id="demandes-envoyees" class="duel-demandes-list"></div>
    </div>
  </main>

  <footer>
    <p data-i18n="footer.copyright">© 2025 VFindz</p>
  </footer>

  <!-- POPUP : écrire les défis -->
  <div id="popup-defi-premium" role="dialog" aria-modal="true" aria-labelledby="pp-title">
    <div class="popup-inner">
      <span class="premium-badge">Premium</span>
      <div id="pp-title" class="popup-title" data-i18n="duel_premium.popup.title">Écris les 3 défis du duel</div>

      <!-- 3 champs (mode: un seul premium) -->
      <input id="pp-d1" class="popup-input" type="text" maxlength="120"
             data-i18n-placeholder="duel_premium.popup.defi1_ph" placeholder="Défi 1 (obligatoire)">
      <input id="pp-d2" class="popup-input" type="text" maxlength="120"
             data-i18n-placeholder="duel_premium.popup.defi2_ph" placeholder="Défi 2 (optionnel)">
      <input id="pp-d3" class="popup-input" type="text" maxlength="120"
             data-i18n-placeholder="duel_premium.popup.defi3_ph" placeholder="Défi 3 (optionnel)">

      <!-- 2 champs (mode: deux premium) -->
      <input id="pp-fixe" class="popup-input" type="text" maxlength="120" style="display:none"
             data-i18n-placeholder="duel_premium.popup.fixed_ph" placeholder="Ton défi fixe (obligatoire)">
      <input id="pp-cand" class="popup-input" type="text" maxlength="120" style="display:none"
             data-i18n-placeholder="duel_premium.popup.candidate_ph" placeholder="Ton défi candidat (pour le tirage)">

      <div class="popup-actions">
        <button id="pp-cancel" class="btn-ghost" data-i18n="common.cancel">Annuler</button>
        <button id="pp-ok" class="btn-primary" data-i18n="duel_premium.popup.start">Lancer le duel</button>
      </div>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="js/userData.js"></script>
  <script src="js/i18n.js"></script>
  
  <script>
    // Back-compat i18n
    window.i18n = window.i18n || {};
    window.i18n.t = (k, vars, fb) => (window.t ? window.t(k, vars, fb) : (fb || k));
    window.i18n.apply = (root) => { if (window.i18nTranslateAll) window.i18nTranslateAll(); };
  </script>

  <script>
    /* ============ Supabase client ============ */
    if (!window.supabase) {
      window.supabase = window.supabaseJsClient = supabase.createClient(
        'https://swmdepiukfginzhbeccz.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3bWRlcGl1a2ZnaW56aGJlY2N6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0MjEyNTksImV4cCI6MjA2Mzk5NzI1OX0.--VONIyPdx1tTi45nd4e-F-ZuKNgbDSY1pP0rXHyJgI'
      );
    }
    const sb = window.supabase;

    let pseudoPublic = null;
    let profil = null;
    let __acceptFriendPseudo = null;
    let __popupMode = 'one_premium_me'; // 'one_premium_me' | 'both_premium'

    /* ============ Helpers ============ */
    const A = (x)=>Array.isArray(x)?x:[];
    const uniq = (arr)=>[...new Set(A(arr).filter(Boolean))];
    function t(key, fb){ try{ return (window.i18n&&window.i18n.t)?window.i18n.t(key): (fb||key);}catch(e){return fb||key;} }

    async function ensureUserReady(maxMs=3000){
      const t0 = Date.now();
      while (Date.now()-t0 < maxMs){
        try{ if (typeof window.getPseudo==='function'){ const p = await window.getPseudo(); if (p) return p; } }catch(e){}
        await new Promise(r=>setTimeout(r,140));
      }
      return null;
    }

    async function getUserByPseudo(pseudo){
      const r = await sb.from('users').select('id,pseudo,premium').eq('pseudo', pseudo).single();
      return (!r.error && r.data) ? r.data : null;
    }

    async function isPremiumUser(){
      try{ if (typeof window.isPremium==='function') return !!(await window.isPremium()); }catch(e){}
      return !!(profil && profil.premium);
    }

    async function loadProfil(){
      if (window.loadUserData) await window.loadUserData();
      if (window.getPseudo) pseudoPublic = await window.getPseudo();
      const r = await sb.from('users')
        .select('id,pseudo,amis,demandesduelrecuespremium,demandesduelenvoyeespremium,premium')
        .eq('pseudo', pseudoPublic).single();
      if (r.data) profil = r.data;
    }

    /* ============ UI Amis & Demandes ============ */
    function afficherAmis(){
      const wrap = document.getElementById('liste-amis');
      wrap.innerHTML = '';
      A(profil && profil.amis).forEach(p=>{
        const row = document.createElement('div');
        row.className = 'ami-card';
        row.innerHTML =
          `<span class="ami-nom">${p}</span>
           <button class="btn-duel-ami" data-i18n="duel_premium.invite">${t('duel_premium.invite','Inviter')}</button>`;
        row.querySelector('.btn-duel-ami').onclick = ()=> inviterDuelPremium(p);
        wrap.appendChild(row);
      });
      if (window.i18n && window.i18n.apply) window.i18n.apply(wrap);
    }

    function buildDuelFilter(meId, amiId){
      const pair=(a,b)=>`and(player1_id.eq.${a},player2_id.eq.${b})`;
      return `${pair(meId,amiId)},${pair(amiId,meId)}`;
    }

    async function findActiveRoom(meId, amiId){
      const filter = buildDuelFilter(meId, amiId);
      const r = await sb.from('duels')
        .select('id,status,type')
        .eq('type','amis_premium')
        .or(filter)
        .in('status',['waiting','playing'])
        .order('createdat',{ascending:false})
        .limit(1);
      return (!r.error && r.data && r.data[0]) ? r.data[0] : null;
    }

    async function afficherDemandesDuel(){
      /* --- Reçues --- */
      const recWrap = document.getElementById('demandes-recue'); recWrap.innerHTML='';
      const rec = uniq(profil && profil.demandesduelrecuespremium);

      if (!rec.length){
        const d = document.createElement('div');
        d.className='aucune-demande';
        d.setAttribute('data-i18n','duel_premium.none_received');
        d.textContent = t('duel_premium.none_received','Aucune demande reçue.');
        recWrap.appendChild(d);
      } else {
        for (const p of rec){
          let rightHTML =
            `<button class="btn-accepter" data-i18n="common.accept">${t('common.accept','Accepter')}</button>
             <button class="btn-refuser"  data-i18n="common.refuse">${t('common.refuse','Refuser')}</button>`;

          try{
            const ami = await getUserByPseudo(p);
            if (ami && profil && profil.id){
              const room = await findActiveRoom(profil.id, ami.id);
              if (room){
                rightHTML = `<a href="duel_game.html?room=${room.id}" class="badge-nouveau" style="background:#65e965;color:#1b2a1b" data-i18n="common.play">${t('common.play','Jouer')}</a>`;
              }
            }
          }catch(e){}

          const d = document.createElement('div'); d.className='demande-card';
          d.innerHTML =
            `<span class="demande-nom">${p}</span>
             <div>${rightHTML}</div>`;
          const btnAcc = d.querySelector('.btn-accepter');
          const btnRef = d.querySelector('.btn-refuser');
          if (btnAcc) btnAcc.onclick = ()=> accepterDuelPremium(p);
          if (btnRef) btnRef.onclick = ()=> refuserDuelPremium(p);
          recWrap.appendChild(d);
        }
      }

      /* --- Envoyées --- */
      const envWrap = document.getElementById('demandes-envoyees'); envWrap.innerHTML='';
      const env = uniq(profil && profil.demandesduelenvoyeespremium);

      if (!env.length){
        const d2 = document.createElement('div');
        d2.className='aucune-demande';
        d2.setAttribute('data-i18n','duel_premium.none_sent');
        d2.textContent = t('duel_premium.none_sent','Aucune demande envoyée.');
        envWrap.appendChild(d2);
      } else {
        for (const amiPseudo of env){
          let statusHTML = `<span class="badge-nouveau" style="background:#b3e2ff;color:#20435a" data-i18n="duel_premium.badge_wait">${t('duel_premium.badge_wait','En attente')}</span>`;
          try{
            const ami = await getUserByPseudo(amiPseudo);
            if (ami && profil && profil.id){
              const room = await findActiveRoom(profil.id, ami.id);
              if (room){
                statusHTML = `<a href="duel_game.html?room=${room.id}" class="badge-nouveau" style="background:#65e965;color:#1b2a1b" data-i18n="common.play">${t('common.play','Jouer')}</a>`;
              }
            }
          }catch(e){}
          const d3 = document.createElement('div'); d3.className='demande-card';
          d3.innerHTML = `<span class="demande-nom">${amiPseudo}</span>${statusHTML}`;
          envWrap.appendChild(d3);
        }
      }

      if (window.i18n && window.i18n.apply){
        window.i18n.apply(recWrap);
        window.i18n.apply(envWrap);
      }
    }

    /* ============ Actions ============ */
    async function inviterDuelPremium(amiPseudo){
      try{
        const prem = await isPremiumUser();
        if (!prem){ alert(t('duel_premium.need_premium_to_invite','Le mode Premium est requis pour inviter.')); return; }
      }catch(e){}
      const ami = await getUserByPseudo(amiPseudo);
      if (!ami){ alert(t('errors.friend_not_found','Ami introuvable.')); return; }
      if (!profil || !profil.id){ alert('Profil non prêt.'); return; }

      // RPC conseillé pour écrire les tableaux demandesduel* côté DB
      const { error } = await sb.rpc('request_premium_duel', {
        p_from: profil.id, p_to: ami.id,
        p_from_pseudo: pseudoPublic, p_to_pseudo: ami.pseudo
      });
      if (error){ console.error('[RPC request_premium_duel]', error); alert('Erreur envoi invitation (RPC).'); return; }

      await loadProfil();
      afficherAmis();
      afficherDemandesDuel();
    }

    function setPopupMode(mode){
      __popupMode = mode;
      const title = document.getElementById('pp-title');
      const d1 = document.getElementById('pp-d1');
      const d2 = document.getElementById('pp-d2');
      const d3 = document.getElementById('pp-d3');
      const fixe = document.getElementById('pp-fixe');
      const cand = document.getElementById('pp-cand');
      const ok   = document.getElementById('pp-ok');

      if (mode==='both_premium'){
        title.textContent = t('duel_premium.popup.title_both_premium','Vous êtes tous deux Premium');
        d1.style.display='none'; d2.style.display='none'; d3.style.display='none';
        fixe.style.display='block'; cand.style.display='block';
        ok.textContent = t('duel_premium.popup.continue','Valider');
      }else{
        title.textContent = t('duel_premium.popup.title_one_premium','Tu es Premium : écris les 3 défis');
        d1.style.display='block'; d2.style.display='block'; d3.style.display='block';
        fixe.style.display='none'; cand.style.display='none';
        ok.textContent = t('duel_premium.popup.start','Lancer le duel');
      }
    }
    function openDefiPopup(friendPseudo, options){
      options = options||{mode:'one_premium_me'};
      __acceptFriendPseudo = friendPseudo;
      ['pp-d1','pp-d2','pp-d3','pp-fixe','pp-cand'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value='';});
      setPopupMode(options.mode||'one_premium_me');
      document.getElementById('popup-defi-premium').classList.add('show');
    }
    function closeDefiPopup(){
      document.getElementById('popup-defi-premium').classList.remove('show');
      __acceptFriendPseudo = null;
    }

    async function accepterDuelPremium(amiPseudo){
      const me = { id: profil ? profil.id : null, pseudo: pseudoPublic, premium: await isPremiumUser() };
      const ami = await getUserByPseudo(amiPseudo);
      if (!ami || !me.id){ alert(t('errors.create_room','Erreur création du duel.')); return; }

      if (me.premium && ami.premium){
        // Deux premium → popup 1 fixe + 1 candidat
        openDefiPopup(amiPseudo, {mode:'both_premium'});
        return;
      }

      if (me.premium && !ami.premium){
        // Moi premium → j’écrirai 3 défis
        openDefiPopup(amiPseudo, {mode:'one_premium_me'});
        return;
      }

      if (!me.premium && ami.premium){
        // Non-premium qui accepte → créer une room waiting en attendant que le premium écrive les 3 défis
        const now = Date.now();
        const payload = [{
          player1_id: ami.id,
          player2_id: me.id,
          player1_pseudo: ami.pseudo,
          player2_pseudo: me.pseudo,
          status: 'waiting',
          createdat: now,
          starttime: now,
          type: 'amis_premium',
          defis_final: null,
          photosa: {}, photosb: {}
        }];
        const ins = await sb.from('duels').insert(payload).select();
        if (ins.error){ console.error(ins.error); alert(t('errors.create_room','Erreur création du duel.')); return; }

        // Nettoyage demandes
        const recMoi = uniq(profil && profil.demandesduelrecuespremium).filter(x=>x!==amiPseudo);
        await sb.from('users').update({ demandesduelrecuespremium: recMoi }).eq('id', me.id);
        try{
          const amiRow = await sb.from('users').select('id,pseudo,demandesduelenvoyeespremium').eq('id', ami.id).single();
          if (amiRow && amiRow.data){
            const envAmi = uniq(amiRow.data.demandesduelenvoyeespremium).filter(x=>x!==me.pseudo);
            await sb.from('users').update({ demandesduelenvoyeespremium: envAmi }).eq('id', ami.id);
          }
        }catch(e){}
        await loadProfil(); afficherDemandesDuel();

        alert(t('duel_premium.info.waiting_premium_defis','Le joueur premium rédigera les défis.'));
        if (ins.data && ins.data.length) location.href = 'duel_game.html?room='+ins.data[0].id;
        return;
      }

      alert(t('errors.create_room','Erreur création du duel.'));
    }

    /* ============ Création / Finalisation selon ton schéma ============ */

    // Mode A : un premium écrit 3 défis → direct playing
    async function createDuelWithDefis_OnePremium(ami, defisArray){
      const now = Date.now();
      const payload = [{
        player1_id: ami.id,
        player2_id: profil.id,
        player1_pseudo: ami.pseudo,
        player2_pseudo: pseudoPublic,
        status: 'playing',
        createdat: now,
        starttime: now,
        type: 'amis_premium',
        defis_final: defisArray, // tableau
        defis: defisArray,       // miroir pour l'UI du jeu (duel_game lit room.defis)
        photosa: {}, photosb: {}
      }];
      const ins = await sb.from('duels').insert(payload).select();
      if (ins.error){ console.error(ins.error); alert(t('errors.create_room','Erreur création du duel.')); return null; }
      return ins.data[0];
    }

    // Mode B : deux premium → chacun 1 fixe + 1 candidat
    async function createOrFinalizeDuel_BothPremium(ami, myFixed, myCand){
      const meId = profil.id, amiId = ami.id;

      // chercher une room waiting entre nous sans defis_final
      const filter = buildDuelFilter(meId, amiId);
      const r = await sb.from('duels')
        .select('id,status,type,player1_id,player2_id,defis1,defis2,defis3a,defis3b,defis_final')
        .eq('type','amis_premium')
        .or(filter)
        .eq('status','waiting')
        .is('defis_final', null)
        .order('createdat',{ascending:false})
        .limit(1);

      const existing = (!r.error && r.data && r.data[0]) ? r.data[0] : null;

      // Si une room existe → on complète mes colonnes (selon mon côté) puis on finalise si tout est rempli
      if (existing){
        const IamP1 = existing.player1_id === meId;
        const update = {};
        if (IamP1){ update.defis1 = myFixed; update.defis3a = myCand || null; }
        else      { update.defis2 = myFixed; update.defis3b = myCand || null; }

        // Pré-calcul pour savoir si tout est prêt après update
        const d1 = IamP1 ? myFixed        : (existing.defis1 || null);
        const d2 = IamP1 ? (existing.defis2||null) : myFixed;
        const cA = IamP1 ? (myCand||null) : (existing.defis3a||null);
        const cB = IamP1 ? (existing.defis3b||null) : (myCand||null);

        // si tout est rempli → tirage d3
        if (d1 && d2 && (cA || cB)){
          const pick = (a,b)=> {
            const arr=[]; if(a)arr.push(a); if(b)arr.push(b);
            return arr[Math.floor(Math.random()*arr.length)];
          };
          const d3 = pick(cA,cB);
          update.defis_final = [d1,d2,d3];
          update.defis = update.defis_final;
          update.status = 'playing';
        }

        const upd = await sb.from('duels').update(update).eq('id', existing.id).select();
        if (upd.error){ console.error(upd.error); alert(t('errors.create_room','Erreur finalisation du duel.')); return existing; }
        return upd.data[0];
      }

      // Sinon → je crée une room waiting avec MA contribution uniquement
      const now = Date.now();
      const I_write_as_P2 = true; // comme dans ton flux précédent : je me positionne player2
      const payload = [{
        player1_id: amiId,
        player2_id: meId,
        player1_pseudo: ami.pseudo,
        player2_pseudo: pseudoPublic,
        status: 'waiting',
        createdat: now,
        starttime: now,
        type: 'amis_premium',
        defis1: I_write_as_P2 ? null     : myFixed,
        defis2: I_write_as_P2 ? myFixed  : null,
        defis3a: I_write_as_P2 ? null    : (myCand || null),
        defis3b: I_write_as_P2 ? (myCand || null) : null,
        defis_final: null,
        photosa: {}, photosb: {}
      }];

      const ins = await sb.from('duels').insert(payload).select();
      if (ins.error){ console.error(ins.error); alert(t('errors.create_room','Erreur création du duel.')); return null; }
      return ins.data[0];
    }

    async function refuserDuelPremium(amiPseudo){
      const recMoi = uniq(profil && profil.demandesduelrecuespremium).filter(x=>x!==amiPseudo);
      await sb.from('users').update({ demandesduelrecuespremium: recMoi }).eq('id', profil.id);
      try{
        const ami = await getUserByPseudo(amiPseudo);
        if (ami){
          const amiRow = await sb.from('users').select('id,pseudo,demandesduelenvoyeespremium').eq('id', ami.id).single();
          if (amiRow && amiRow.data){
            const envAmi = uniq(amiRow.data.demandesduelenvoyeespremium).filter(x=>x!==pseudoPublic);
            await sb.from('users').update({ demandesduelenvoyeespremium: envAmi }).eq('id', ami.id);
          }
        }
      }catch(e){}
      await loadProfil(); afficherDemandesDuel();
    }

    /* ============ Bootstrap ============ */
    document.addEventListener('DOMContentLoaded', async ()=>{
      try{ if (typeof window.afficherSolde==='function'){ try{ await window.afficherSolde(); }catch(e){} } }catch(e){}

      await ensureUserReady(3000);
      await loadProfil();

      if (!(await isPremiumUser())){
        const a = document.getElementById('premium-alert');
        a.style.display='block';
        a.setAttribute('data-i18n','duel_premium.premium_only');
        document.getElementById('liste-amis').innerHTML =
          "<div class='aucune-demande' data-i18n='duel_premium.premium_only'>Invitation réservée aux premium.</div>";
        afficherDemandesDuel();
      }else{
        afficherAmis();
        afficherDemandesDuel();
      }

      // Marquer les notifs comme lues
      try{
        const me = await sb.from('users').select('id,demandesduelrecuespremium').eq('id', profil && profil.id).single();
        if (me && me.data && A(me.data.demandesduelrecuespremium).length>0){
          await sb.from('users').update({ demandesduelrecuespremium: [] }).eq('id', me.data.id);
        }
        localStorage.setItem('duelPremiumNotifCount','0');
      }catch(e){}

      // Realtime (ma ligne users)
      try{
        window.__duelPremChan = sb.channel('duel-premium-'+(profil?.id||'me'))
          .on('postgres_changes',
              {event:'UPDATE',schema:'public',table:'users',filter:'id=eq.'+(profil?.id||'0')},
              async ()=>{ await loadProfil(); afficherAmis(); afficherDemandesDuel(); })
          .subscribe();
      }catch(e){}

      // Popup actions
      document.getElementById('pp-cancel').onclick = ()=> closeDefiPopup();
      document.getElementById('pp-ok').onclick = async ()=>{
        const friend = __acceptFriendPseudo;
        if (!friend){ closeDefiPopup(); return; }
        const ami = await getUserByPseudo(friend);
        if (!ami){ alert(t('errors.friend_not_found','Ami introuvable.')); return; }

        if (__popupMode==='one_premium_me'){
          // Moi premium → 3 défis
          const d1 = (document.getElementById('pp-d1').value||'').trim();
          const d2 = (document.getElementById('pp-d2').value||'').trim();
          const d3 = (document.getElementById('pp-d3').value||'').trim();
          if (!d1){ alert(t('duel_premium.need_d1','Le défi 1 est obligatoire.')); return; }
          const arr=[d1]; if(d2)arr.push(d2); if(d3)arr.push(d3);

          closeDefiPopup();
          const room = await createDuelWithDefis_OnePremium(ami, arr);

          // Nettoyage demandes
          try{
            const recMoi = uniq(profil && profil.demandesduelrecuespremium).filter(x=>x!==friend);
            await sb.from('users').update({ demandesduelrecuespremium: recMoi }).eq('id', profil.id);
            const amiRow = await sb.from('users').select('id,pseudo,demandesduelenvoyeespremium').eq('id', ami.id).single();
            if (amiRow && amiRow.data){
              const envAmi = uniq(amiRow.data.demandesduelenvoyeespremium).filter(x=>x!==pseudoPublic);
              await sb.from('users').update({ demandesduelenvoyeespremium: envAmi }).eq('id', ami.id);
            }
          }catch(e){}
          await loadProfil(); afficherDemandesDuel();

          if (room) location.href = 'duel_game.html?room='+room.id;
          return;
        }

        if (__popupMode==='both_premium'){
          // Deux premium → fixe + candidat
          const fixe = (document.getElementById('pp-fixe').value||'').trim();
          const cand = (document.getElementById('pp-cand').value||'').trim();
          if (!fixe){ alert(t('duel_premium.need_d1','Le défi 1 est obligatoire.')); return; }

          closeDefiPopup();
          const room = await createOrFinalizeDuel_BothPremium(ami, fixe, cand);

          // Nettoyage demandes (côté acceptant)
          try{
            const recMoi = uniq(profil && profil.demandesduelrecuespremium).filter(x=>x!==friend);
            await sb.from('users').update({ demandesduelrecuespremium: recMoi }).eq('id', profil.id);
            const amiRow = await sb.from('users').select('id,pseudo,demandesduelenvoyeespremium').eq('id', ami.id).single();
            if (amiRow && amiRow.data){
              const envAmi = uniq(amiRow.data.demandesduelenvoyeespremium).filter(x=>x!==pseudoPublic);
              await sb.from('users').update({ demandesduelenvoyeespremium: envAmi }).eq('id', ami.id);
            }
          }catch(e){}
          await loadProfil(); afficherDemandesDuel();

          if (room) location.href = 'duel_game.html?room='+room.id;
          return;
        }
      };

      if (window.i18n && window.i18n.apply) window.i18n.apply(document.body);
    });
  </script>
</body>
</html>
