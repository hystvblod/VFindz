<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title data-i18n="duel_premium.title">Duel Premium</title>
  <link rel="stylesheet" href="style/main.css" />
  <style>
    .duel-main{max-width:420px;margin:2.4rem auto 0;background:rgba(38,41,56,.93);border-radius:1.3rem;box-shadow:0 8px 32px #0003,0 2px 0 #232435;padding:2.2rem 1.4rem 1.6rem}
    .section-titre{color:#e8eaf6;font-size:1.15em;font-weight:600;margin:1.7em 0 .7em;text-align:center}
    .amis-list{display:flex;flex-direction:column;gap:1.1rem;margin-bottom:2.2rem}
    .ami-card{display:flex;align-items:center;justify-content:space-between;background:#2e3047;border-radius:.9rem;padding:.9em 1.2em;box-shadow:0 3px 12px #0002;min-height:52px}
    .ami-nom{font-weight:600;font-size:1.14em;color:#ffe04a;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px}
    .btn-duel-ami{background:#ffe04a;color:#2b2b2b;font-weight:700;border:none;border-radius:8px;padding:7px 16px;font-size:1.03em;box-shadow:0 2px 8px #0002;cursor:pointer}
    .duel-demandes-list{background:#24263b;border-radius:.9rem;padding:1em 1em .6em;min-height:45px;box-shadow:0 2px 8px #0001}
    .demande-card{display:flex;align-items:center;justify-content:space-between;margin-bottom:.6em;gap:.6em}
    .demande-nom{font-weight:500;color:#ffe04a;font-size:1.03em;max-width:160px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .badge-nouveau{background:#ffe04a;color:#2a2a23;font-size:.97em;border-radius:6px;padding:1px 7px;margin-left:5px;font-weight:700;box-shadow:0 1px 4px #0001}
    .btn-accepter,.btn-refuser{border:none;border-radius:8px;padding:6px 14px;font-weight:700;font-size:.97em;cursor:pointer}
    .btn-accepter{background:#65e965;color:#253a25}
    .btn-refuser{background:#f36d6d;color:#232323}
    .aucune-demande{color:#bdbdc8;text-align:center;font-size:1.01em;margin:.3em 0 .8em}

    /* POPUP plein écran & centrée */
    #popup-defi-premium{position:fixed;inset:0;z-index:99999;display:none;align-items:center;justify-content:center;background:rgba(30,32,48,.84);width:100vw;height:100vh}
    #popup-defi-premium.show{display:flex}
    .popup-inner{background:#232435;border-radius:1.23em;padding:1.6em 1.2em 1.2em;width:440px;max-width:94vw;box-shadow:0 8px 28px #0007;color:#e9ecff}
    .premium-badge{border-radius:7px;padding:4px 13px;font-size:1.04em;font-weight:700;margin-bottom:10px;background:#ffe04a;color:#242424;display:inline-block}
    .popup-title{font-size:1.21em;font-weight:800;color:#ffe04a;margin:4px 0 10px}
    .popup-input{width:100%;border-radius:9px;padding:10px;margin-bottom:10px;border:1.5px solid #ffe04a;font-size:1.02em;background:#1f2133;color:#fff}
    .popup-actions{display:flex;gap:.6em;justify-content:flex-end;margin-top:8px}
    .btn-primary{background:#ffe04a;color:#232323;font-weight:800;border:none;border-radius:9px;padding:10px 22px;font-size:1.02em;box-shadow:0 2px 8px #0002;cursor:pointer}
    .btn-ghost{background:#dddbe2;color:#222;border:none;border-radius:9px;padding:10px 22px;font-size:1.02em}
    @media (max-width:600px){.duel-main{max-width:98vw;padding:1.1em .5em}.ami-nom{max-width:110px}.demande-nom{max-width:90px}.popup-inner{width:92vw}}
  </style>
</head>
<body class="duel-container">

  <header class="header-solo">
    <div class="header-row">
      <a href="profil.html" class="back-btn" title="Retour" data-i18n-title="header.back">
        <img src="assets/icons/arrow_back.svg" alt="Retour" data-i18n-alt="header.back"/>
      </a>
      <h1 data-i18n="duel_premium.title">Duel Premium</h1>
      <div class="top-buttons">
        <a href="index.html" class="btn-icon" aria-label="Profil" data-i18n-aria-label="button.profile">
          <img src="assets/icons/user.svg" alt="Profil" data-i18n-alt="button.profile" />
        </a>
        <a href="parametres.html" class="btn-icon" aria-label="Paramètres" data-i18n-aria-label="button.settings">
          <img src="assets/icons/settings.svg" alt="Paramètres" data-i18n-alt="button.settings" />
        </a>
      </div>
    </div>
    <div class="solde-container solde-solo" id="solde-container">
      <div class="solde-item">
        <div class="solde-ligne">
          <img src="assets/img/vcoin.webp" class="icon-solo-piece" alt="Pièces" data-i18n-alt="solde.pieces" />
          <span id="points"></span>
        </div>
      </div>
      <div class="solde-item">
        <div class="solde-ligne">
          <img src="assets/img/jeton_p.webp" class="icon-solo-jeton" alt="Jetons" data-i18n-alt="solde.jetons" />
          <span id="jetons"></span>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="duel-main">
      <div id="premium-alert" style="display:none;color:#f36d6d;text-align:center;margin-bottom:1.1em;font-weight:bold" data-i18n="duel_premium.premium_only">Invitation réservée aux premium.</div>

      <div class="section-titre" data-i18n="duel_premium.section.friends">Mes amis</div>
      <div id="liste-amis" class="amis-list"></div>

      <div class="section-titre" style="margin-top:2.4em" data-i18n="duel_premium.section.received">Demandes de duel premium reçues</div>
      <div id="demandes-recue" class="duel-demandes-list"></div>

      <div class="section-titre" style="margin-top:2.4em" data-i18n="duel_premium.section.sent">Demandes de duel premium envoyées</div>
      <div id="demandes-envoyees" class="duel-demandes-list"></div>
    </div>
  </main>

  <footer>
    <p data-i18n="footer.copyright">© 2025 VFindz</p>
  </footer>

  <!-- POPUP : écrire les défis -->
  <div id="popup-defi-premium" role="dialog" aria-modal="true" aria-labelledby="pp-title">
    <div class="popup-inner">
      <span class="premium-badge">Premium</span>
      <div id="pp-title" class="popup-title" data-i18n="duel_premium.popup.title">Écris les 3 défis du duel</div>
      <input id="pp-d1" class="popup-input" type="text" maxlength="120" data-i18n-placeholder="duel_premium.popup.defi1_ph" placeholder="Défi 1 (obligatoire)">
      <input id="pp-d2" class="popup-input" type="text" maxlength="120" data-i18n-placeholder="duel_premium.popup.defi2_ph" placeholder="Défi 2 (optionnel)">
      <input id="pp-d3" class="popup-input" type="text" maxlength="120" data-i18n-placeholder="duel_premium.popup.defi3_ph" placeholder="Défi 3 (optionnel)">
      <div class="popup-actions">
        <button id="pp-cancel" class="btn-ghost" data-i18n="common.cancel">Annuler</button>
        <button id="pp-ok" class="btn-primary" data-i18n="duel_premium.popup.start">Lancer le duel</button>
      </div>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="js/userData.js"></script>
  <script src="js/i18n.js"></script>

  <script>
    // --- Supabase client ---
    if (!window.supabase) {
      window.supabase = window.supabaseJsClient = supabase.createClient(
        'https://swmdepiukfginzhbeccz.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN3bWRlcGl1a2ZnaW56aGJlY2N6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0MjEyNTksImV4cCI6MjA2Mzk5NzI1OX0.--VONIyPdx1tTi45nd4e-F-ZuKNgbDSY1pP0rXHyJgI'
      );
    }
    const sb = window.supabase; // alias sûr

    let pseudoPublic = null;
    let profil = null;
    let __acceptFriendPseudo = null;

    // --- Helpers ---
    const A = (x) => Array.isArray(x) ? x : [];
    const uniq = (arr) => [...new Set(A(arr).filter(Boolean))];

    async function ensureUserReady(maxMs=3000){
      const t0 = Date.now();
      while (Date.now() - t0 < maxMs) {
        try { if (typeof window.getPseudo === 'function') {
          const p = await window.getPseudo(); if (p) return p;
        }} catch(e){}
        await new Promise(r=>setTimeout(r,140));
      }
      return null;
    }

    async function getUserByPseudo(pseudo){
      const { data, error } = await sb.from('users').select('id,pseudo').eq('pseudo', pseudo).single();
      if (error || !data) return null;
      return data;
    }

    async function isPremiumUser(){
      try { if (typeof window.isPremium === 'function') return !!(await window.isPremium()); } catch(e){}
      return !!profil?.premium;
    }

    async function loadProfil(){
      await window.loadUserData?.();
      pseudoPublic = await window.getPseudo?.();
      const { data } = await sb
        .from('users')
        .select('id,pseudo,amis,demandesduelrecuespremium,demandesduelenvoyeespremium,premium')
        .eq('pseudo', pseudoPublic)
        .single();
      if (data) profil = data;
    }

    // --- UI ---
    function afficherAmis(){
      const wrap = document.getElementById('liste-amis');
      wrap.innerHTML = '';
      A(profil?.amis).forEach(p => {
        const row = document.createElement('div');
        row.className = 'ami-card';
        row.innerHTML = `
          <span class="ami-nom">${p}</span>
          <button class="btn-duel-ami" data-i18n="duel_premium.invite">Inviter</button>`;
        row.querySelector('.btn-duel-ami').onclick = () => inviterDuelPremium(p);
        wrap.appendChild(row);
      });
      window.i18n && window.i18n.apply && window.i18n.apply(wrap);
    }

    async function afficherDemandesDuel(){
      // reçues
      const recWrap = document.getElementById('demandes-recue'); recWrap.innerHTML='';
      const rec = uniq(profil?.demandesduelrecuespremium);
      if (!rec.length){
        const d = document.createElement('div');
        d.className='aucune-demande';
        d.setAttribute('data-i18n','duel_premium.none_received');
        d.textContent='Aucune demande reçue.';
        recWrap.appendChild(d);
      } else {
        rec.forEach(p => {
          const d = document.createElement('div'); d.className='demande-card';
          d.innerHTML = `
            <span class="demande-nom">${p}<span class="badge-nouveau" data-i18n="duel_premium.badge_new">Nouveau</span></span>
            <div>
              <button class="btn-accepter" data-i18n="common.accept">Accepter</button>
              <button class="btn-refuser"  data-i18n="common.refuse">Refuser</button>
            </div>`;
          d.querySelector('.btn-accepter').onclick = () => accepterDuelPremium(p);
          d.querySelector('.btn-refuser').onclick  = () => refuserDuelPremium(p);
          recWrap.appendChild(d);
        });
      }

      // envoyées
      const envWrap = document.getElementById('demandes-envoyees'); envWrap.innerHTML='';
      const env = uniq(profil?.demandesduelenvoyeespremium);
      if (!env.length){
        const d = document.createElement('div');
        d.className='aucune-demande';
        d.setAttribute('data-i18n','duel_premium.none_sent');
        d.textContent='Aucune demande envoyée.';
        envWrap.appendChild(d);
      } else {
        for (const amiPseudo of env) {
          let statusHTML = `<span class="badge-nouveau" style="background:#b3e2ff;color:#20435a" data-i18n="duel_premium.badge_wait">En attente</span>`;
          try {
            const ami = await getUserByPseudo(amiPseudo);
            if (ami && profil?.id) {
              const { data: rooms } = await sb
                .from('duels').select('id,status')
                .or(`and(player1_id.eq.${profil.id},player2_id.eq.${ami.id}),and(player1_id.eq.${ami.id},player2_id.eq.${profil.id})`)
                .in('status', ['playing','waiting']);
              if (rooms && rooms.length) {
                statusHTML = `<a href="duel_game.html?room=${rooms[0].id}" class="badge-nouveau" style="background:#65e965;color:#1b2a1b" data-i18n="common.play">Jouer</a>`;
              }
            }
          } catch(e){}
          const d = document.createElement('div'); d.className='demande-card';
          d.innerHTML = `<span class="demande-nom">${amiPseudo}</span>${statusHTML}`;
          envWrap.appendChild(d);
        }
      }
      window.i18n && window.i18n.apply && window.i18n.apply(envWrap);
    }

    // --- Actions ---
    async function inviterDuelPremium(amiPseudo){
      try { if (!(await isPremiumUser())) { alert((i18n&&i18n.t)? i18n.t('duel_premium.need_premium_to_invite') : 'Le mode Premium est requis pour inviter.'); return; } } catch(e){}
      const ami = await getUserByPseudo(amiPseudo);
      if (!ami) { alert((i18n&&i18n.t)? i18n.t('errors.friend_not_found') : 'Ami introuvable.'); return; }
      if (!profil?.id) { alert('Profil non prêt.'); return; }

      // RPC si dispo
      try {
        const { error: rpcErr } = await sb.rpc('request_premium_duel', {
          p_from: profil.id, p_to: ami.id,
          p_from_pseudo: pseudoPublic, p_to_pseudo: ami.pseudo
        });
        if (!rpcErr) { await loadProfil(); afficherAmis(); afficherDemandesDuel(); return; }
      } catch(e){}

      // Fallback manuel
      try {
        const { data: meNow }  = await sb.from('users').select('demandesduelenvoyeespremium').eq('id', profil.id).single();
        const { data: amiNow } = await sb.from('users').select('demandesduelrecuespremium').eq('id', ami.id).single();
        const env = uniq(meNow?.demandesduelenvoyeespremium); if (!env.includes(ami.pseudo)) env.push(ami.pseudo);
        const rec = uniq(amiNow?.demandesduelrecuespremium); if (!rec.includes(pseudoPublic)) rec.push(pseudoPublic);
        await sb.from('users').update({ demandesduelenvoyeespremium: env }).eq('id', profil.id);
        await sb.from('users').update({ demandesduelrecuespremium: rec }).eq('id', ami.id);
        await loadProfil(); afficherAmis(); afficherDemandesDuel();
      } catch(e){ alert('Erreur d’envoi de la demande.'); }
    }

    // Popup
    function openDefiPopup(friendPseudo){
      __acceptFriendPseudo = friendPseudo;
      document.getElementById('pp-d1').value='';
      document.getElementById('pp-d2').value='';
      document.getElementById('pp-d3').value='';
      document.getElementById('popup-defi-premium').classList.add('show');
    }
    function closeDefiPopup(){
      document.getElementById('popup-defi-premium').classList.remove('show');
      __acceptFriendPseudo = null;
    }

    async function accepterDuelPremium(amiPseudo){ openDefiPopup(amiPseudo); }

    async function createDuelWithDefis(amiPseudo, defisObj){
      const ami = await getUserByPseudo(amiPseudo);
      if (!ami || !profil?.id) { alert((i18n&&i18n.t)? i18n.t('errors.create_room') : 'Erreur création du duel.'); return; }

      const now = Date.now();
      const insertPayload = [{
        player1_id: ami.id,
        player2_id: profil.id,
        player1_pseudo: ami.pseudo,
        player2_pseudo: pseudoPublic,
        score1: 0, score2: 0,
        status: 'playing',           // ou 'waiting'
        createdat: now,
        starttime: now,
        type: 'amis_premium',
        defis: null,
        defis_final: defisObj,
        photosa: {}, photosb: {}
      }];

      const { data, error } = await sb.from('duels').insert(insertPayload).select();
      if (error) { console.error(error); alert((i18n&&i18n.t)? i18n.t('errors.create_room') : 'Erreur création du duel.'); return; }

      // nettoyer demandes
      const recMoi = uniq(profil.demandesduelrecuespremium).filter(p=>p!==amiPseudo);
      await sb.from('users').update({ demandesduelrecuespremium: recMoi }).eq('id', profil.id);
      try {
        const { data: amiRow } = await sb.from('users').select('id,pseudo,demandesduelenvoyeespremium').eq('id', ami.id).single();
        if (amiRow) {
          const envAmi = uniq(amiRow.demandesduelenvoyeespremium).filter(p=>p!==pseudoPublic);
          await sb.from('users').update({ demandesduelenvoyeespremium: envAmi }).eq('id', ami.id);
        }
      } catch(e){}

      await loadProfil(); afficherDemandesDuel();
      if (data && data.length) location.href = `duel_game.html?room=${data[0].id}`;
    }

    async function refuserDuelPremium(amiPseudo){
      const recMoi = uniq(profil.demandesduelrecuespremium).filter(p=>p!==amiPseudo);
      await sb.from('users').update({ demandesduelrecuespremium: recMoi }).eq('id', profil.id);
      try {
        const ami = await getUserByPseudo(amiPseudo);
        if (ami) {
          const { data: amiRow } = await sb.from('users').select('id,pseudo,demandesduelenvoyeespremium').eq('id', ami.id).single();
          if (amiRow) {
            const envAmi = uniq(amiRow.demandesduelenvoyeespremium).filter(p=>p!==pseudoPublic);
            await sb.from('users').update({ demandesduelenvoyeespremium: envAmi }).eq('id', ami.id);
          }
        }
      } catch(e){}
      await loadProfil(); afficherDemandesDuel();
    }

    // --- Bootstrap ---
    document.addEventListener('DOMContentLoaded', async ()=>{
      try { if (typeof window.afficherSolde === 'function') { try { await window.afficherSolde(); } catch(e){} } } catch(e){}

      await ensureUserReady();
      await loadProfil();

      if (!(await isPremiumUser())) {
        const a = document.getElementById('premium-alert');
        a.style.display = 'block';
        a.setAttribute('data-i18n','duel_premium.premium_only');
        document.getElementById('liste-amis').innerHTML =
          "<div class='aucune-demande' data-i18n='duel_premium.premium_only'>Invitation réservée aux premium.</div>";
        afficherDemandesDuel();
      } else {
        afficherAmis();
        afficherDemandesDuel();
      }

      // Marquer comme vues
      try {
        const { data: me } = await sb.from('users').select('id,demandesduelrecuespremium').eq('id', profil?.id).single();
        if (me && A(me.demandesduelrecuespremium).length > 0) {
          await sb.from('users').update({ demandesduelrecuespremium: [] }).eq('id', me.id);
        }
        localStorage.setItem('duelPremiumNotifCount','0');
      } catch(e){}

      // Realtime
      try {
        window.__duelPremChan = sb.channel('duel-premium-'+(profil?.id||'me'))
          .on('postgres_changes',{event:'UPDATE',schema:'public',table:'users',filter:`id=eq.${profil?.id}`},
            async ()=>{ await loadProfil(); afficherAmis(); afficherDemandesDuel(); })
          .subscribe();
      } catch(e){}

      // Popup actions
      document.getElementById('pp-cancel').onclick = () => closeDefiPopup();
      document.getElementById('pp-ok').onclick = async () => {
        const d1 = (document.getElementById('pp-d1').value||'').trim();
        const d2 = (document.getElementById('pp-d2').value||'').trim();
        const d3 = (document.getElementById('pp-d3').value||'').trim();
        if (!d1) { alert((i18n&&i18n.t)? i18n.t('duel_premium.need_d1') : 'Le défi 1 est obligatoire.'); return; }
        const defis = { d1 }; if (d2) defis.d2 = d2; if (d3) defis.d3 = d3;
        const friend = __acceptFriendPseudo; closeDefiPopup();
        await createDuelWithDefis(friend, defis);
      };

      // i18n initial
      window.i18n && window.i18n.apply && window.i18n.apply(document.body);
    });
  </script>
</body>
</html>
