<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title data-i18n="header.title.cadres">Mes cadres</title>
  <link rel="stylesheet" href="style/main.css"/>
</head>
<body class="page-container">


    <header class="header-solo">
    <div class="header-row">
      <a href="profil.html" class="back-btn" title="Retour" data-i18n-title="header.back">
        <img src="assets/icons/arrow_back.svg" alt="Retour" data-i18n-alt="header.back"/>
      </a>
      <div class="header-center">
        <h1 data-i18n="header.title.cadres">Mes cadres</h1>
      </div>
      <div class="header-actions">
        <a class="btn btn-primary" href="importCadres.html" data-i18n="header.import">Importer</a>
      </div>
    </div>
  </header>

  <main>
    <section class="cadres-possedes">
      <div class="grid-cadres" id="cadres-list">
        <!-- Cadres injectés dynamiquement -->
      </div>
    </section>
  </main>

  <footer>
    <p data-i18n="footer">© 2025 VFindz</p>
  </footer>

  <!-- 1. Charge Supabase (AVANT tout !) -->
  <script src="js/i18n.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="js/userData.js"></script>
  <script src="js/cadres.js"></script>

  <script>
    // Pop-up zoom sur le cadre
    window.zoomCadre = function(id) {
      const popup = document.createElement("div");
      popup.className = "popup show";
      popup.innerHTML = `
        <div class="popup-inner">
          <button id="close-popup" onclick="document.body.removeChild(this.parentNode.parentNode)">✖</button>
          <div id="zoom-holder" style="position:relative;width:300px;height:375px;margin:auto;"></div>
        </div>
      `;
      document.body.appendChild(popup);

      const holder = popup.querySelector('#zoom-holder');

      // image/photo de prévisualisation
      const photo = document.createElement('img');
      photo.src = 'assets/preview.jpg';
      photo.style.position = "absolute";
      photo.style.inset = "0";
      photo.style.width = "100%";
      photo.style.height = "100%";
      photo.style.objectFit = "cover";
      photo.style.zIndex = "1";
      holder.appendChild(photo);

      const cadreEl = createCadreElement(id, { w: 300, h: 375 });
      holder.appendChild(cadreEl);
    };

    // Utiliser un cadre
    window.utiliserCadre = async function(id) {
      if (typeof window.setCadreSelectionne === "function") {
        await window.setCadreSelectionne(id);
        alert(window.i18n ? window.i18n("toast.success.setframe") : "✅ Cadre sélectionné !");
      } else {
        alert(window.i18n ? window.i18n("toast.error.setframe") : "Erreur : setCadreSelectionne non chargé !");
      }
    };

    // Afficher tous les cadres possédés
    async function afficherCadres() {
      const container = document.getElementById("cadres-list");
      if (!container) return;

      // Utilise les fonctions globales (chargées dans userData.js)
      const getCadresPossedes = window.getCadresPossedes;
      const getCadreSelectionne = window.getCadreSelectionne;

      if (!getCadresPossedes || !getCadreSelectionne) {
        container.innerHTML = `<p data-i18n="main.error.notloaded">Erreur : fonctions non chargées.</p>`;
        return;
      }

      const cadresPossedes = await getCadresPossedes();
      const cadreActif = await getCadreSelectionne();

      container.innerHTML = "";

      if (!cadresPossedes.length) {
        container.innerHTML = `<p data-i18n="main.noframes">Aucun cadre débloqué !</p>`;
        return;
      }

      cadresPossedes.forEach(cadre => {
        const div = document.createElement("div");
        div.className = "cadre-item";

        const holder = document.createElement("div");
        holder.className = "cadre-preview";
        holder.style.position = "relative";
        holder.style.width = "140px";
        holder.style.height = "175px";

        const photo = document.createElement("img");
        photo.src = 'assets/preview.jpg';
        photo.style.position = "absolute";
        photo.style.inset = "0";
        photo.style.width = "100%";
        photo.style.height = "100%";
        photo.style.objectFit = "cover";
        photo.style.zIndex = "1";
        holder.appendChild(photo);

        const el = createCadreElement(cadre, { w: 140, h: 175 });
        el.style.position = "absolute";
        el.style.inset = "0";
        el.style.zIndex = "2";
        holder.appendChild(el);

        const row = document.createElement("div");
        row.className = "cadre-actions";
        row.innerHTML = `
          <button class="btn btn-secondary" onclick="zoomCadre('${cadre}')">Zoom</button>
          <button class="btn btn-primary" ${cadre === cadreActif ? 'disabled' : ''} onclick="utiliserCadre('${cadre}')">
            ${cadre === cadreActif ? 'Actif' : 'Utiliser'}
          </button>
        `;

        div.appendChild(holder);
        div.appendChild(row);
        container.appendChild(div);
      });
    }

    // Initialisation : s'assurer que userData.js est bien chargé
    document.addEventListener("DOMContentLoaded", async () => {
      // attendre que les fonctions globales soient là
      let tries = 0;
      while ((!window.getCadresPossedes || !window.getCadreSelectionne) && tries < 50) {
        await new Promise(res => setTimeout(res, 100));
        tries++;
      }
      await afficherCadres();
    });
  </script>
</body>
</html>
