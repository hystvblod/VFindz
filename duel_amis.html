<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Duel priv√© ‚Ä¢ VFind</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      background: #0f1220;
      color: #fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial;
      margin: 0; padding: 0;
    }
    header {
      padding: 16px 20px;
      display:flex; align-items:center; justify-content:space-between;
      background: #181b2e; border-bottom: 1px solid #232746;
    }
    header .title { font-weight: 700; font-size: 1.15rem; letter-spacing:.02em; }
    main { padding: 18px 16px 28px; max-width: 900px; margin: 0 auto; }
    .card {
      background: #16192a; border: 1px solid #262a47; border-radius: 14px;
      padding: 14px 14px 16px; margin-bottom: 14px; box-shadow: 0 8px 24px rgba(0,0,0,.25);
    }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input[type="text"] {
      background:#0f1324; color:#fff; border:1px solid #2a3056;
      border-radius:10px; padding:10px 12px; outline:none; min-width:220px;
    }
    button {
      background:#5a63ff; color:#fff; border: none; border-radius: 10px;
      padding: 10px 14px; cursor: pointer; font-weight:600;
    }
    button[disabled] { opacity:.55; cursor:not-allowed; }
    .list { display:grid; gap:10px; }
    .invite {
      display:flex; align-items:center; justify-content:space-between;
      background:#12162a; border:1px solid #242a4a; border-radius:12px; padding:10px 12px;
    }
    .invite b { color:#ffe04a; }
    .chip {
      font-size:.86rem; background:#23306b; padding:4px 8px; border-radius:999px; color:#d1d8ff;
      border:1px solid #2e3b86;
    }
    .actions { display:flex; gap:8px; }
    .btn-outline {
      background:transparent; border:1px solid #3b4273; color:#dfe3ff;
    }
    .hint { color:#aab2e6; font-size:.92rem; }
    .empty { color:#9aa1c8; font-style: italic; }
    .sep { height: 1px; background:#232746; margin: 14px 0; }
    a.link { color:#9fb3ff; text-decoration:none; }
  </style>
</head>
<body>
  <header>
    <div class="title">Duel priv√©</div>
    <div class="hint" id="me-label">‚Äî</div>
  </header>

  <main>
    <!-- Cr√©er / envoyer une invitation -->
    <section class="card">
      <h2 style="margin: 0 0 10px 0; font-size:1.05rem;">Inviter un ami par pseudo</h2>
      <div class="row">
        <input type="text" id="pseudo-cible" placeholder="Pseudo de ton ami" />
        <button id="btn-inviter">Envoyer l‚Äôinvitation</button>
      </div>
      <div class="hint" style="margin-top:8px;">L‚Äôinvitation cr√©e une salle en <b>attente</b>. Ton ami la verra dans ‚ÄúInvitations re√ßues‚Äù.</div>
    </section>

    <!-- Invitations re√ßues -->
    <section class="card">
      <h2 style="margin: 0 0 10px 0; font-size:1.05rem;">Invitations re√ßues</h2>
      <div id="list-recues" class="list"></div>
    </section>

    <!-- Invitations envoy√©es -->
    <section class="card">
      <h2 style="margin: 0 0 10px 0; font-size:1.05rem;">Invitations envoy√©es</h2>
      <div id="list-envoyees" class="list"></div>
    </section>

    <div class="sep"></div>
    <div class="hint">
      Astuce : lorsque l‚Äôinvitation est accept√©e, la partie d√©marre (24h).<br/>
      Tu seras redirig√© vers <code>duel_game.html</code>.
    </div>
  </main>

  <!-- D√©pendances (assure-toi que ces fichiers existent d√©j√† dans ton projet) -->
  <script>
    // Supabase est initialis√© dans userData.js (via window.supabase)
  </script>
  <script src="js/userData.js"></script>
  <script src="js/duel.js"></script>

  <script>
    // ========= Logic Duel Priv√© (s√©curis√© c√¥t√© client) =========
    // R√®gle importante : on NE fait AUCUN update sur la table `users` ici.
    // On ne manipule QUE la table `duels` (insert / update status), ce qui est couvert par vos RLS.
    // Bonus : on s'aligne sur la logique "random" (status waiting/playing/cancelled/finished).

    const $ = (id) => document.getElementById(id);

    let ME = { id: null, pseudo: null };

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Auth anonyme si besoin + chargement profil
        await (window.ensureAuth ? window.ensureAuth() : null);
        const data = await (window.getUserDataCloud ? window.getUserDataCloud() : null);
        ME.id = data?.id || null;
        ME.pseudo = data?.pseudo || "Moi";
        $('me-label').textContent = `Connect√© en tant que ${ME.pseudo}`;
      } catch (e) {
        console.warn('Auth/profil non dispo:', e);
      }

      // Bouton inviter
      $('btn-inviter').onclick = envoyerInvitation;

      // Abonnements & premiers chargements
      await initialLoad();
      subscribeRealtime();
    });

    async function initialLoad() {
      await Promise.all([chargerInvitationsRecues(), chargerInvitationsEnvoyees()]);
    }

    function subscribeRealtime() {
      try {
        const ch = window.supabase
          .channel('duels_prive_'+(ME.id || 'x'))
          .on('postgres_changes', { event: '*', schema: 'public', table: 'duels' }, async (payload) => {
            // Filtre simple : si la ligne me concerne (en tant que p1/p2), on rafra√Æchit
            const d = payload.new;
            if (!d) return;
            if (d.player1_id === ME.id || d.player2_id === ME.id) {
              await Promise.all([chargerInvitationsRecues(), chargerInvitationsEnvoyees()]);
              // Si la room passe en playing et me concerne, redirige vers la partie
              if (d.status === 'playing' && (d.player1_id === ME.id || d.player2_id === ME.id)) {
                // petit d√©lai pour laisser l'UI se mettre √† jour
                setTimeout(() => { window.location.href = `duel_game.html?room=${d.id}`; }, 250);
              }
            }
          })
          .subscribe();
      } catch (e) {
        console.warn('Realtime non dispo:', e);
      }
    }

    async function envoyerInvitation() {
      const pseudoCible = $('pseudo-cible').value.trim();
      if (!pseudoCible) {
        alert("Entre le pseudo de ton ami.");
        return;
      }
      if (!ME.id) {
        alert("Utilisateur non connect√©.");
        return;
      }

      try {
        // 1) Retrouver l'utilisateur cible par pseudo (LECTURE SEULE)
        const { data: cible, error: err1 } = await window.supabase
          .from('users')
          .select('id, pseudo, premium')
          .eq('pseudo', pseudoCible)
          .maybeSingle();

        if (err1) throw err1;
        if (!cible || !cible.id) {
          alert("Pseudo introuvable.");
          return;
        }
        if (cible.id === ME.id) {
          alert("Tu ne peux pas t‚Äôinviter toi-m√™me üòÖ");
          return;
        }

        // 2) D√©j√† une invitation en attente (dans un sens ou l‚Äôautre) ?
        const { data: exist, error: err2 } = await window.supabase
          .from('duels')
          .select('id, status')
          .in('status', ['waiting','playing'])
          .or(`and(player1_id.eq.${ME.id},player2_id.eq.${cible.id}),and(player1_id.eq.${cible.id},player2_id.eq.${ME.id})`);

        if (err2) throw err2;
        if (Array.isArray(exist) && exist.length) {
          alert("Une salle existe d√©j√† entre vous (en attente ou en cours).");
          return;
        }

        // 3) G√©n√©rer 3 d√©fis (cloud d‚Äôabord, sinon local) ‚Äî m√™me logique que duel.js
        let defis = [];
        try {
          if (typeof window.getDefisDuelFromSupabase === 'function') {
            defis = await window.getDefisDuelFromSupabase(3);
          }
        } catch(_) {}
        if (!defis || !defis.length) {
          if (typeof window.getDefisLocal === 'function') defis = await window.getDefisLocal(3);
          else defis = ["Prends une photo d‚Äôun objet rond", "Quelque chose de rouge", "Ta boisson du moment"];
        }

        // 4) Cr√©er la room (INSERT DANS `duels` UNIQUEMENT)
        //    RLS doit emp√™cher d‚Äôusurper un autre user_id. √âvite d‚Äô√©crire des champs sensibles (points/jetons) ici.
        const room = {
          player1_id: ME.id,
          player1_pseudo: ME.pseudo,
          player2_id: cible.id,
          player2_pseudo: cible.pseudo,
          score1: 0,
          score2: 0,
          status: 'waiting',       // en attente de l‚Äôacceptation
          createdat: Date.now(),
          defis: defis,
          starttime: null,
          photosa: {},
          photosb: {},
          type: 'amis'             // duel priv√©
        };
        const { data: inserted, error: err3 } = await window.supabase
          .from('duels')
          .insert([room])
          .select();

        if (err3) throw err3;
        if (!inserted || !inserted[0]) {
          alert("Erreur lors de la cr√©ation de la salle.");
          return;
        }

        $('pseudo-cible').value = "";
        await chargerInvitationsEnvoyees();
        alert(`Invitation envoy√©e √† ${cible.pseudo} !`);

      } catch (e) {
        console.error(e);
        alert("Impossible d‚Äôenvoyer l‚Äôinvitation : " + (e?.message || e));
      }
    }

    async function chargerInvitationsRecues() {
      if (!ME.id) return;
      const wrap = $('list-recues');
      wrap.innerHTML = '<div class="hint">Chargement‚Ä¶</div>';

      const { data, error } = await window.supabase
        .from('duels')
        .select('id, player1_id, player1_pseudo, createdat, type, status')
        .eq('player2_id', ME.id)
        .eq('status', 'waiting')
        .order('createdat', { ascending: false });

      if (error) {
        wrap.innerHTML = `<div class="empty">Erreur : ${error.message}</div>`;
        return;
      }
      if (!data || !data.length) {
        wrap.innerHTML = '<div class="empty">Aucune invitation re√ßue.</div>';
        return;
      }

      wrap.innerHTML = '';
      data.forEach(inv => {
        const el = document.createElement('div');
        el.className = 'invite';
        el.innerHTML = `
          <div>
            <div><b>${inv.player1_pseudo || "?"}</b> t‚Äôinvite √† jouer</div>
            <div class="chip" title="${new Date(inv.createdat).toLocaleString()}">cr√©√©e ${timeAgo(inv.createdat)}</div>
          </div>
          <div class="actions">
            <button class="btn-outline" data-act="refuse" data-id="${inv.id}">Refuser</button>
            <button data-act="accept" data-id="${inv.id}">Accepter</button>
          </div>
        `;
        wrap.appendChild(el);
      });

      wrap.querySelectorAll('button').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.dataset.id;
          if (btn.dataset.act === 'accept') await accepterInvitation(id);
          else await refuserInvitation(id);
        };
      });
    }

    async function chargerInvitationsEnvoyees() {
      if (!ME.id) return;
      const wrap = $('list-envoyees');
      wrap.innerHTML = '<div class="hint">Chargement‚Ä¶</div>';

      const { data, error } = await window.supabase
        .from('duels')
        .select('id, player2_pseudo, createdat, type, status')
        .eq('player1_id', ME.id)
        .eq('status', 'waiting')
        .order('createdat', { ascending: false });

      if (error) {
        wrap.innerHTML = `<div class="empty">Erreur : ${error.message}</div>`;
        return;
      }
      if (!data || !data.length) {
        wrap.innerHTML = '<div class="empty">Aucune invitation envoy√©e.</div>';
        return;
      }

      wrap.innerHTML = '';
      data.forEach(inv => {
        const el = document.createElement('div');
        el.className = 'invite';
        el.innerHTML = `
          <div>
            <div>En attente de <b>${inv.player2_pseudo || "?"}</b></div>
            <div class="chip" title="${new Date(inv.createdat).toLocaleString()}">cr√©√©e ${timeAgo(inv.createdat)}</div>
          </div>
          <div class="actions">
            <button class="btn-outline" data-act="cancel" data-id="${inv.id}">Annuler</button>
          </div>
        `;
        wrap.appendChild(el);
      });

      wrap.querySelectorAll('button').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.dataset.id;
          if (btn.dataset.act === 'cancel') await annulerInvitation(id);
        };
      });
    }

    async function accepterInvitation(duelId) {
      try {
        // Passe la salle en "playing" et d√©marre le timer 24h
        const { data, error } = await window.supabase
          .from('duels')
          .update({ status: 'playing', starttime: Date.now() })
          .eq('id', duelId)
          .eq('player2_id', ME.id) // s√©curit√© c√¥t√© client ; RLS doit valider c√¥t√© serveur
          .select();

        if (error) throw error;
        if (!data || !data[0]) {
          alert("Impossible d‚Äôaccepter l‚Äôinvitation.");
          return;
        }
        // Redirige vers la game
        setTimeout(() => { window.location.href = `duel_game.html?room=${duelId}`; }, 150);
      } catch (e) {
        console.error(e);
        alert("Erreur : " + (e?.message || e));
      }
    }

    async function refuserInvitation(duelId) {
      try {
        const { error } = await window.supabase
          .from('duels')
          .update({ status: 'cancelled' })
          .eq('id', duelId)
          .eq('player2_id', ME.id);

        if (error) throw error;
        await chargerInvitationsRecues();
      } catch (e) {
        console.error(e);
        alert("Erreur : " + (e?.message || e));
      }
    }

    async function annulerInvitation(duelId) {
      try {
        const { error } = await window.supabase
          .from('duels')
          .update({ status: 'cancelled' })
          .eq('id', duelId)
          .eq('player1_id', ME.id);

        if (error) throw error;
        await chargerInvitationsEnvoyees();
      } catch (e) {
        console.error(e);
        alert("Erreur : " + (e?.message || e));
      }
    }

    function timeAgo(ts) {
      const d = typeof ts === 'number' ? ts : (parseInt(ts,10) || Date.now());
      const diff = Date.now() - d;
      const s = Math.floor(diff/1000);
      if (s < 60) return "√† l‚Äôinstant";
      const m = Math.floor(s/60);
      if (m < 60) return `il y a ${m} min`;
      const h = Math.floor(m/60);
      if (h < 24) return `il y a ${h} h`;
      const j = Math.floor(h/24);
      return `il y a ${j} j`;
    }
  </script>
</body>
</html>
